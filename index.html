<!-- RUNTIME SKELETON (EN) -->
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<style>
body{margin:0;background:#0b1020;color:#e8ecf4;font-family:'Assistant',system-ui,Segoe UI,Roboto,Helvetica,Arial}
.progress{margin-top:10px;height:8px;background:rgba(255,255,255,.06);border-radius:999px;overflow:hidden;border:1px solid rgba(255,255,255,.08)}
.progress__bar{height:100%;width:0%;background:linear-gradient(90deg,#60a5fa,#a78bfa);transition:width .08s linear}
.sub{margin:0 0 12px;color:#9aa3b2;font-size:14px}
.stage{min-height:100vh;display:flex;align-items:center;justify-content:center}
.phone{
  width:min(420px, 92vw);
  height:calc(min(420px, 92vw) * 1.78); /* יחס נעים ~16:9 */
  border-radius:28px;
  box-shadow:0 20px 60px rgba(0,0,0,.35);
  overflow:hidden;
  border:1px solid rgba(255,255,255,.08);
  background:#0f152a;
  display:flex;               /* חשוב: מאפשר לילד למלא גובה */
  flex-direction:column;      /* כותרת סטטוס למעלה, תוכן מתחת */
}
@media (max-width: 480px){
  .stage{ min-height:100svh; align-items:stretch; justify-content:stretch; }
  .phone{ width:100vw; height:100svh; border-radius:0; border:0; box-shadow:none; }
  .wrap{ padding:clamp(16px,4vw,24px); }
}

/* status bar (preview-only) */
.status{height:26px;display:flex;align-items:center;justify-content:space-between;padding:0 10px;
font-size:12px;color:#aeb7c8;background:linear-gradient(0deg,rgba(255,255,255,.06),rgba(255,255,255,.09))}
.status .dots{display:flex;gap:4px}
.status .dot{width:6px;height:6px;border-radius:50%;background:#aeb7c8;opacity:.85}
.wrap{
  padding:16px;
  flex:1;                           /* ימלא את כל גובה ה"טלפון" */
  overflow:auto;                     /* כאן הגלילה מתבצעת */
  -webkit-overflow-scrolling: touch; /* אינרציה חלקה באייפון */
  overscroll-behavior: contain;      /* לא מושך את העמוד שמסביב */
}
.card{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:16px}
.h1{font-size:22px;font-weight:800;margin:0 0 6px}
.p{margin:0 0 10px;color:#9aa3b2}
.btn{appearance:none;border:0;border-radius:0px;padding:12px 14px;font-weight:800;cursor:pointer}
.btn-primary{background:linear-gradient(90deg,#34d399,#10b981);color:#062d24}
.badge{display:inline-block;padding:4px 8px;border-radius:999px;background:#1d243d;border:1px solid rgba(255,255,255,.08);font-size:12px;color:#9aa3b2;margin-bottom:10px}
/* Infinite: inline percent inside the button + canvas confetti */
.btn{position:relative}
.btn .label{pointer-events:none}
.btn .percent{position:absolute; right:14px; top:50%; transform:translateY(-50%); font-size:12px; opacity:.9}

/* earned is hidden by default */
.earned{display:none}

/* gentle shake */
@keyframes infShake{10%,90%{transform:translateX(-1px)}20%,80%{transform:translateX(2px)}30%,50%,70%{transform:translateX(-4px)}40%,60%{transform:translateX(4px)}}
.shake{animation:infShake .35s linear 1}

/* confetti canvas */
.confetti-canvas{position:fixed; inset:0; pointer-events:none; z-index:999}
.confetti-canvas{ width:100vw; height:100vh }
  /* Kefpo brand badge (runtime-only) */
.kf-badge{
  position: sticky;         /* נדבק לראש אזור הגלילה של .wrap */
  top: 8px;
  align-self: center;
  display: inline-flex; gap: 8px; align-items: center;
  padding: 6px 10px;
  border-radius: 999px;
  background: rgba(255,255,255,.05);
  border: 1px solid rgba(255,255,255,.10);
  box-shadow: 0 6px 18px rgba(0,0,0,.25);
  color: #9aa3b2; font-size: 12px; font-weight: 800;
  text-decoration: none;
  z-index: 5;
}
.kf-badge:hover{ border-color: rgba(255,255,255,.18); transform: translateY(-1px); }
.kf-badge i{ width: 8px; height: 8px; border-radius: 50%;
  background: linear-gradient(90deg,#60a5fa,#a78bfa);
  box-shadow: 0 0 10px rgba(167,139,250,.6);
}
  /* Custom scrollbar for touch devices (mobile only) */
@media (hover:none) and (pointer:coarse){
  .custom-scrollbar{
    position:absolute; top:10px; bottom:10px; right:6px;
    width:3px; border-radius:999px;
    background:rgba(255,255,255,.08);   /* מסילה דקה וסטטית */
    pointer-events:none;                 /* לא חוסם נגיעות בתוכן */
    display:none;                        /* יוצג רק כשיש מה לגלול */
  }
  .custom-scrollbar .thumb{
    position:absolute; left:0; top:0; width:100%;
    height:36px; border-radius:999px;
    background:rgba(255,255,255,.50);   /* האגודל */
    opacity:0; transition:opacity .25s;
  }
  .wrap.scrolling .custom-scrollbar .thumb{ opacity:.9; }  /* מודגש בזמן גלילה */
}
</style>

<!-- Infinite UX extra classes -->
<style id="infinite-ux">
/* מצבי צבע לכפתור (מעבר בין שלבים) */
.btn.alt1{background:#7c3aed;color:#fff}
.btn.alt2{background:#0ea5e9;color:#fff}
.btn.success{background:#10b981;color:#fff}

/* אפקטים עדינים לרקע הכרטיס */
.wrap.fx-alert{animation:infFlashRed .8s ease-in-out 2 alternate}
@keyframes infFlashRed{0%{background:#0f1218}100%{background:#241112}}
.wrap.fx-calm{animation:infCalm .8s ease forwards}
@keyframes infCalm{from{background:#241112}to{background:#0f1218}}
.wrap.fx-blue{animation:infBlue .7s ease-in-out 2 alternate}
@keyframes infBlue{0%{box-shadow:0 0 0 0 rgba(0,144,255,.10)}100%{box-shadow:0 0 0 14px rgba(0,144,255,.08)}}
.wrap.fx-pink{animation:infPink .7s ease-in-out 2 alternate}
@keyframes infPink{0%{box-shadow:0 0 0 0 rgba(238,0,120,.10)}100%{box-shadow:0 0 0 14px rgba(238,0,120,.08)}}

/* קונפטי "פוף" שמכסה את כל הוופורט (אבל נשאר בתוך #app) */
.confetti-fixed{pointer-events:none;position:fixed;inset:0;z-index:999;overflow:hidden}
.confetti-fixed span{position:absolute;top:-20px;font-size:20px;animation:infFall 1.8s linear forwards}
@keyframes infFall{to{transform:translateY(110vh) rotate(240deg);opacity:.95}}
/* Infinite-only layout & sizing */
.wrap-infinite{
  display:grid;
  gap:20px;              /* ריווח נעים בין כל האלמנטים */
  justify-items:center;  /* מרכז הכל אופקית */
  text-align:center;     /* טקסט ממורכז */
  margin-top: clamp(12px, 6vh, 48px);
}
.wrap-infinite h1{ margin:0; font-size:26px; line-height:1.25 }
.wrap-infinite .sub{ margin:0; font-size:15px; opacity:.9 }

/* כפתור גדול ואמין (אחיד לכל המצבים) */
.wrap-infinite .btn{
  width:min(320px, 100%);
  min-height:48px;
  padding:14px 18px;
  font-size:16px;
  border-radius:16px;
  font-weight:800;
  margin:0 auto;
}

/* בר־התקדמות מיושר לרוחב הכפתור */
.wrap-infinite .progress{ width:min(320px, 100%); margin-top:2px }

/* earned – קצת רווח מעל */
.wrap-infinite .earned{ margin-top:8px }
  
/* כפתור הצלחה ירוק */
.btn.green{ background:#10b981; color:#fff }
</style>

<!-- CAPTCHA UX styles (clean + tap improvements) -->
<style id="captcha-ux">
  .wrap-captcha{
    display:grid; gap:24px; justify-items:center; text-align:center;
    margin-top:clamp(24px, 12vh, 96px);
  }
  .cap-title{ margin:0; font-size:26px; line-height:1.25; font-weight:800 }
  .cap-sub{ margin:0; font-size:15px; color:#9aa3b2 }
  .cap-grid{
    display:grid; grid-template-columns:repeat(3,minmax(0,1fr)); gap:8px;
    width:min(360px, 100%);
  }
  .cap-tile{
    position:relative; aspect-ratio:1/1; border-radius:0px; overflow:hidden;
    border:1px solid rgba(255,255,255,.10); background:#12182b; cursor:pointer;
    transition:transform .04s ease, box-shadow .12s ease;

    /* tap fast + no highlight on mobile */
    touch-action: manipulation;
    -webkit-tap-highlight-color: transparent;
    user-select: none;
    will-change: transform;
  }
  .cap-tile:hover{ transform:translateY(-1px); box-shadow:0 8px 20px rgba(0,0,0,.25) }
  .cap-img{
    position:absolute; inset:0; width:100%; height:100%; object-fit:cover;
    pointer-events:none; -webkit-user-drag:none; user-select:none;
  }
  .cap-filler{ position:absolute; inset:0; display:flex; align-items:center; justify-content:center;
    font-size:34px; filter:saturate(1.1); background:linear-gradient(135deg,#0f152a,#141a32) }
  .cap-tile.sel::after{
    content:"✓"; position:absolute; right:8px; top:6px; font-weight:900; font-size:16px;
    background:#10b981; color:#062d24; border-radius:999px; padding:2px 6px;
    box-shadow:0 2px 10px rgba(0,0,0,.25);
  }
  .cap-cta{ width:min(320px, 100%); min-height:48px; padding:14px 18px; font-size:16px;
    border-radius:16px; font-weight:800; margin:0 auto }
  .cap-cta.error{ animation:infShake .35s linear 1 }
  .cap-cta.green{ background:#10b981; color:#fff }
  .cap-hint{ font-size:12px; color:#9aa3b2 }
</style>
<!-- SELFIE UX (styles) -->
<style id="selfie-ux">
  .wrap-selfie{
    display:grid; gap:24px; justify-items:center; text-align:center;
    margin-top: clamp(24px, 10vh, 96px);
  }
  .sf-title{ margin:0; font-size:26px; line-height:1.25; font-weight:800 }
  .sf-sub{ margin:0; font-size:15px; color:#9aa3b2 }
  .sf-cta{ width:min(320px,100%); min-height:48px; padding:14px 18px; font-size:16px;
           border-radius:16px; font-weight:800; margin:0 auto }
  .sf-hint{ font-size:12px; color:#9aa3b2 }
  .sf-phone-only{ opacity:.9 }

  .sf-cam{
    position:relative; width:min(360px,100%); aspect-ratio:3/4;
    background:#0f152a; border:1px solid rgba(255,255,255,.10); border-radius:16px; overflow:hidden;
  }
  .sf-cam video, .sf-cam .sf-fallback{
    position:absolute; inset:0; width:100%; height:100%; object-fit:cover;
  }
  .sf-fallback{
    display:flex; align-items:center; justify-content:center; padding:16px;
    background:repeating-linear-gradient(135deg,#12182b 0 16px,#0e1326 16px 32px);
    color:#9aa3b2; font-weight:700; font-size:18px;
  }
  /* make hidden actually hide + keep video on top */
#app .sf-fallback[hidden]{ display:none !important; }
#app .sf-cam video{ z-index:2 }
#app .sf-cam .sf-fallback{ z-index:1 }

  .sf-status{
    display:flex; align-items:center; gap:10px; justify-content:center;
    font-size:14px; color:#9aa3b2;
  }
  .sf-spinner{ width:18px; height:18px; border:3px solid rgba(255,255,255,.15);
               border-top-color:#a78bfa; border-radius:50%; animation:sfSpin 1s linear infinite }
  @keyframes sfSpin{ to{ transform:rotate(360deg) } }

  .sf-check{
    position:absolute; inset:0; display:flex; align-items:center; justify-content:center;
    font-size:72px; color:#10b981; text-shadow:0 6px 24px rgba(0,0,0,.35);
    pointer-events:none; opacity:0; transform:scale(.9); transition:.25s ease;
  }
  .sf-check.on{ opacity:1; transform:scale(1) }

  /* Filters */
/* Neutral selfie – no color filter, mirror only */
.fx-none video{ filter:none !important; transform:scaleX(-1); }
  .fx-ugly1 video{ filter:hue-rotate(120deg) saturate(2) contrast(1.2); transform:scaleX(-1) }
  .fx-ugly2 video{ filter:hue-rotate(260deg) saturate(2.4) contrast(1.15) brightness(1.08); transform:scaleX(-1) }
  .fx-ugly3 video{ filter:hue-rotate(180deg) saturate(2.2) contrast(1.2) drop-shadow(0 4px 22px rgba(0,0,0,.25)); transform:scaleX(-1) }

  .green{ background:#10b981; color:#fff }
  .ghost{ background:#0b1020; color:#9aa3b2; border:1px solid rgba(255,255,255,.12) }
  .sf-row{ display:flex; gap:8px; flex-wrap:wrap; justify-content:center }

  /* Confetti canvas */
  .confetti-canvas{ position:fixed; inset:0; pointer-events:none; z-index:999; display:none }
  /* Kill LED only (keep everything else) */
#app .sf-led,
#app .sf-monkey.led::before,
#app .sf-monkey.led::after,
#app .sf-monkey::before,
#app .sf-monkey::after{
  display:none !important;
  animation:none !important;
}
</style>

<div class="stage">
<div id="phone" class="phone">
<!-- יוזר אמיתי לא יראה את הסטטוס־בר; מוצג רק כשpreview=1 -->
<div id="status" class="status" style="display:none">
<div>9:41</div>
<div class="dots"><span class="dot"></span><span class="dot"></span><span class="dot"></span></div>
</div>
<div class="wrap">
  <div id="app" class="card"></div>
  <!-- custom mobile scrollbar (inside the phone) -->
  <div id="mScroll" class="custom-scrollbar"><i class="thumb"></i></div>
</div>

<script>
(function(){
const qs = new URLSearchParams(location.search);
const F = (qs.get('f')||'').trim(); // feature slug
const NAME = (qs.get('name')||'Friend').trim();
const GIFT = (qs.get('giftUrl')||'#').trim();
const PREV = (qs.get('preview')||'0').trim()==='1';
function getCopy(key, fallback) {
  const v = qs.get(key);
  if (!v || v.trim().length === 0) return fallback;
  return v.trim().slice(0, 80);
}
// === High‑quality SFX (from your GitHub) with safe fallback ===
const SFX_BASE = 'https://tubile.github.io/kefpo-sfx/';
const SFX_FILES = {
  click:   'click.mp3',
  confirm: 'confirm.mp3',
  error:   'error.mp3',
  tada:    'tada.mp3',
  whoosh:  'whoosh.mp3'
};

// Preload one Audio element per sound (ניצור שיבוט בכל השמעה כדי לאפשר חפיפה)
const __SFX = {};
for (const [k,f] of Object.entries(SFX_FILES)) {
  const a = new Audio(SFX_BASE + f);
  a.preload = 'auto';
  a.crossOrigin = 'anonymous'; // בטוח גם אם תרצה WebAudio בעתיד
  __SFX[k] = a;
}

// ניסיון “פריימינג” עדין לפתיחת אודיו במובייל בהקשה הראשונה
document.addEventListener('pointerdown', ()=>{
  try{
    const a = __SFX.click;
    a.muted = true;
    const p = a.play();
    if (p && p.then) p.then(()=>{ a.pause(); a.currentTime = 0; a.muted = false; });
  }catch(_){}
}, { once:true });

function sfx(kind){
  const key = (kind in __SFX) ? kind : 'click';
  try{
    // מנגן שיבוט כדי לאפשר כמה צלילים זה על זה
    const a = __SFX[key].cloneNode(true);
    a.play().catch(()=>{ /* ייתכן בלוק אוטופליי – נתעלם בשקט */ });
  }catch(e){
    // Fallback – ביפ סינתטי (כמו שהיה)
    try{
      const ctx = new (window.AudioContext || window.webkitAudioContext)();
      const o = ctx.createOscillator(), g = ctx.createGain();
      const now = ctx.currentTime, freq = { error:180, whoosh:420, tada:880, confirm:520, click:660 }[kind] || 600;
      o.type='sine'; o.frequency.setValueAtTime(freq, now);
      g.gain.setValueAtTime(0.0001, now);
      g.gain.exponentialRampToValueAtTime(0.2, now + 0.02);
      g.gain.exponentialRampToValueAtTime(0.0001, now + 0.15);
      o.connect(g); g.connect(ctx.destination); o.start(); o.stop(now + 0.16);
    }catch(_) {}
  }
}

// הצג סטטוס־בר רק בפריביו
if (PREV) document.getElementById('status').style.display = 'flex';
  // Runtime-only brand badge (hide in preview)
if (!PREV) {
  const wrap = document.querySelector('.wrap');
  const appEl = document.getElementById('app');
  if (wrap && appEl && !document.getElementById('kfBadge')) {
    const a = document.createElement('a');
    a.id = 'kfBadge';
    a.className = 'kf-badge';
    a.href = 'https://kefpo.co';
    a.target = '_blank';
    a.rel = 'noopener';
    a.innerHTML = '<i aria-hidden="true"></i><span>Made by Kefpo.co</span>';
    wrap.insertBefore(a, appEl);   // חשוב: מחוץ ל-#app כדי שלא ימחק בהחלפת מסכים
  }
}

function el(html){ document.getElementById('app').innerHTML = html; }
  // ----- Custom mobile scrollbar logic -----
const WRAP = document.querySelector('.wrap');
const SB   = document.getElementById('mScroll');
const TH   = SB ? SB.querySelector('.thumb') : null;

function updateScrollbar(){
  if(!WRAP || !SB || !TH) return;
  const sh = WRAP.scrollHeight, ch = WRAP.clientHeight, st = WRAP.scrollTop;
  // אם אין עודף גובה – לא להציג את הפס
  if (sh <= ch + 1){ SB.style.display = 'none'; return; }
  SB.style.display = ''; // יש גלילה → להציג

  // חישוב גובה האגודל ומיקומו
  const track = SB.clientHeight;
  const minThumb = 28;
  const thumbH = Math.max(minThumb, Math.round(track * (ch / sh)));
  const y = Math.round((track - thumbH) * (st / (sh - ch)));
  TH.style.height = thumbH + 'px';
  TH.style.transform = `translateY(${y}px)`;
}

let hideTimer;
if (WRAP){
  WRAP.addEventListener('scroll', ()=>{
    WRAP.classList.add('scrolling');
    updateScrollbar();
    clearTimeout(hideTimer);
    hideTimer = setTimeout(()=> WRAP.classList.remove('scrolling'), 400);
  }, {passive:true});

  // כשמתחלף מסך בפיצ'ר (אנחנו משנים innerHTML על #app) – לחשב מחדש
  const obs = new MutationObserver(()=> requestAnimationFrame(updateScrollbar));
  obs.observe(document.getElementById('app'), { childList:true, subtree:true });

  window.addEventListener('resize', updateScrollbar);
  // חישוב ראשון
  requestAnimationFrame(updateScrollbar);
}

// ===== Voice Verify (final) =====
function voiceVerify(){
  // הזרקת CSS חד‑פעמית לפיצ'ר (כדי שלא תצטרך לעדכן <style> נפרד)
  if (!document.getElementById('voice-ux')){
    const st = document.createElement('style');
    st.id = 'voice-ux';
    st.textContent = `
      .wrap-voice{
        display:grid; gap:24px; justify-items:center; text-align:center;
        margin-top:clamp(24px, 10vh, 96px);
}
.vv-cow{
  width:min(360px, 100%);
  border-radius:16px;
  background:linear-gradient(180deg,#1b1f34,#111528);
  display:flex; align-items:center; justify-content:center;
  box-shadow:inset 0 0 0 1px rgba(255,255,255,.06), 0 20px 40px rgba(0,0,0,.35);
  padding:24px;
}
.vv-cow .emoji{
  font-size:120px; line-height:1;
  user-select:none; -webkit-user-drag:none;
}

/* Alert toast overlay — identical look to the reference */
.toast{
  position:fixed; inset:0; display:none; place-items:center;
  background:rgba(10,12,22,.6); backdrop-filter:blur(3px);
  text-align:center; padding:24px; z-index:1000;
}
.toast.show{ display:grid }
.toast .box{
  background:#1a1f35; border-radius:16px; padding:20px;
  box-shadow:0 10px 30px rgba(0,0,0,.35); max-width:320px
}
.toast h3{ margin:0 0 6px 0 }
      .vv-title{ margin:0; font-size:26px; line-height:1.25; font-weight:800 }
      .vv-sub{ margin:0; font-size:15px; color:#9aa3b2 }
      .vv-animal{
        width:min(360px, 100%); aspect-ratio:16/10;
        border-radius:16px; overflow:hidden; border:1px solid rgba(255,255,255,.10);
        background:#12182b; display:flex; align-items:center; justify-content:center;
      }
      .vv-animal img{ width:88%; height:88%; object-fit:contain; user-select:none; -webkit-user-drag:none }
      .vv-rec{ display:grid; gap:10px; width:min(320px, 100%); }
      .vv-meter{
        height:10px; border-radius:999px; overflow:hidden; background:rgba(255,255,255,.08);
        border:1px solid rgba(255,255,255,.08); position:relative;
      }
      .vv-meter > i{
        position:absolute; left:0; top:0; bottom:0; width:0%;
        background:linear-gradient(90deg,#f59e0b,#ef4444);
        transition: width .06s linear;
      }
      .vv-time{ font-size:12px; color:#9aa3b2 }
      .vv-err{ font-size:14px; color:#fca5a5; min-height:18px }
      .btn.red{ background:#ef4444; color:#fff }
      .btn.blue{ background:#3b82f6; color:#fff }
    `;
    document.head.appendChild(st);
  }

  // קריאת פרמטרים (חוזה runtime): ?f=voice-verify&name=&giftUrl=&preview=1
  const qs   = new URLSearchParams(location.search);
  const PREV = (qs.get('preview')||'0').trim()==='1';
  const NAME = (qs.get('name')||'Friend').trim();
  const GIFT = (qs.get('giftUrl')||'#').trim();

  const app = document.getElementById('app');
  app.classList.remove('card'); // “מסך נקי” כמו בשאר הפיצ'רים
  // --- SFX gate (voice-verify only): allow only 'error' and 'tada'
const __sfxGlobal = window.sfx; // שמור מצביע לפונקציית הסאונד הגלובלית של הרנטיים
function sfx(kind){
  if (kind === 'error' || kind === 'tada'){
    try{ __sfxGlobal && __sfxGlobal(kind); }catch(e){}
  }
  // כל השאר (click / confirm / whoosh ...) – מושתקים כאן מקומית
}

  // טקסטים לפי הבריף (ניתנים לאובררייד דרך URL אם תרצה)
  const copy = {
    introTitle: (qs.get('introTitle') || `${NAME}, a special gift is waiting! 🎁`).slice(0,80),
    introSub:   (qs.get('introSub')   || `To claim it, please verify your identity.`).slice(0,80),
    introBtn:   (qs.get('introBtn')   || `Verify & get the gift`).slice(0,32),

    recTitle:   (qs.get('recTitle')   || `לאימות זהותך הקלט את הצליל של החיה המוצגת`).slice(0,80),
    errText:    (qs.get('errText')    || `לא הצלחנו לקלוט צליל, הקלט שוב חזק יותר`).slice(0,80),

    okTitle:    (qs.get('okTitle')    || `הרווחת את זה ביושר 😂`).slice(0,80),
    okSub:      (qs.get('okSub')      || `לחץ על הכפתור כדי לקבל את המתנה האמיתית שלך`).slice(0,80),
    okBtn:      (qs.get('okBtn')      || `קבל את המתנה`).slice(0,32)
  };

  // תמונת “פרה” self-contained (SVG emoji) — ללא רשת/אחסון
  function cowDataURL(){
    const svg =
      `<svg xmlns='http://www.w3.org/2000/svg' width='800' height='500'>
         <rect width='100%' height='100%' fill='#0f1324'/>
         <text x='50%' y='55%' text-anchor='middle' font-size='180'>🐮</text>
       </svg>`;
    return 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(svg);
  }

  // קונפטי (כמו בשאר הפיצ'רים)
  function confettiBurst(canvas){
    if(!canvas) return;
    const ctx = canvas.getContext('2d');
    const r = window.devicePixelRatio || 1;
    function size(){ canvas.width = canvas.clientWidth * r; canvas.height = canvas.clientHeight * r; ctx.setTransform(r,0,0,r,0,0); }
    if(!canvas.__sized){ canvas.__sized = true; canvas.style.display='block'; size(); window.addEventListener('resize', size); }
    const colors = ['#a78bfa','#60a5fa','#34d399','#f472b6','#f59e0b'];
    const pieces = [];
    const w = canvas.clientWidth, h = canvas.clientHeight;
    for(let i=0;i<120;i++){
      pieces.push({ x:w/2, y:h/2, vx:(Math.random()*4-2), vy:(Math.random()*-3-2),
        r:Math.random()*6+3, c:colors[(Math.random()*colors.length)|0], a:1, spin:(Math.random()*6.28), vr:(Math.random()*0.2-0.1) });
    }
    const g = 0.05; let t=0;
    (function step(){
      ctx.clearRect(0,0,w,h);
      pieces.forEach(p=>{
        p.vy += g; p.x += p.vx; p.y += p.vy; p.spin += p.vr; p.a -= 0.008;
        ctx.globalAlpha = Math.max(p.a,0);
        ctx.save(); ctx.translate(p.x,p.y); ctx.rotate(p.spin);
        ctx.fillStyle = p.c; ctx.fillRect(-p.r/2,-p.r/2,p.r,p.r);
        ctx.restore();
      });
      ctx.globalAlpha = 1;
      if(t++<260) requestAnimationFrame(step); else ctx.clearRect(0,0,w,h);
    })();
  }

  // מסך פתיחה
  function screenIntro(){
    app.innerHTML = `
      <div class="wrap wrap-voice">
        <h1 class="vv-title">${copy.introTitle}</h1>
        <p class="vv-sub">${copy.introSub}</p>
        <button id="vv-start" class="btn btn-green">${copy.introBtn}</button>
        <div class="vv-sub" style="font-size:12px">no data collected</div>
      </div>
    `;
    document.getElementById('vv-start').addEventListener('click', ()=>{
      try{sfx('confirm')}catch(e){}
      screenRecord();
    });
  }

  // מסך ההקלטה (נסיון ראשון → שגיאה אמינה; נסיון שני → הצלחה)
  function screenRecord(){
    app.innerHTML = `
      <div class="wrap wrap-voice">
        <h1 class="vv-title">${copy.recTitle}</h1>
        <div class="vv-cow" id="vv-cow" aria-hidden="true"><div class="emoji">🐄</div></div>

        <div class="vv-rec">
          <button id="rec-btn" class="btn blue"><span id="rec-label">Start recording</span></button>
          <div class="vv-meter" aria-hidden="true"><i id="rec-meter"></i></div>
          <div class="vv-time" id="rec-time">00:00</div>
          <div class="vv-err" id="rec-err" aria-live="polite"></div>
        </div>

        ${ PREV ? `<div class="vv-sub">Preview mode</div>` : `` }
<div class="toast" id="vv-toast">
  <div class="box">
    <h3>לא הצלחנו לקלוט צליל</h3>
    <p>נסה שוב - הפעם חזק וברור יותר.</p>
    <div style="height:10px"></div>
    <button id="vv-tryagain" class="btn btn-primary">אישור</button>
  </div>
</div>
<!-- Error toast #2 (same style, texts reveal the prank) -->
<div class="toast" id="vv-toast2">
  <div class="box">
    <h3>יש לך כישרון לזה</h3>
    <p>נסה שוב, רק כי זה גורם לי לצחוק.</p>
    <div style="height:10px"></div>
    <button id="vv-tryagain2" class="btn btn-primary">יאללה, ננסה שוב</button>
  </div>
</div>
        <canvas id="vv-confetti" class="confetti-canvas"></canvas>
      </div>
    `;

    const btn   = document.getElementById('rec-btn');
    const label = document.getElementById('rec-label');
    const meter = document.getElementById('rec-meter');
    const time  = document.getElementById('rec-time');
    const errEl = document.getElementById('rec-err');
    const wrap  = document.querySelector('.wrap-voice');
    const conf  = document.getElementById('vv-confetti');
    // Toast #1
const toast = document.getElementById('vv-toast');
const tryAgain = document.getElementById('vv-tryagain');

// Toast #2 (אם הוספת אותו)
const toast2 = document.getElementById('vv-toast2');
const tryAgain2 = document.getElementById('vv-tryagain2');

// הזזת הטוסטים מחוץ ל-wrap כדי לא להיות צאצאים של אלמנט עם transform (shake)
if (toast && !toast.__moved){ document.body.appendChild(toast); toast.__moved = true; }
if (toast2 && !toast2.__moved){ document.body.appendChild(toast2); toast2.__moved = true; }

// חיווט כפתורי "אישור"
if (tryAgain)  tryAgain.addEventListener('click', ()=>{ toast.classList.remove('show'); });
if (tryAgain2) tryAgain2.addEventListener('click', ()=>{ toast2.classList.remove('show'); });

    let recording = false;
    let attempt   = 0;
    let t0        = 0;
    let raf       = 0;
    let autoStop  = 0;

    // הגדרות אודיו (ויזואלי בלבד — בלי שמירה/שליחה)
    let stream = null, audioCtx = null, analyser = null, data = null;

    function fmt(ms){
      const s = Math.max(0, Math.floor(ms/1000));
      const m = String(Math.floor(s/60)).padStart(2,'0');
      const r = String(s%60).padStart(2,'0');
      return `${m}:${r}`;
    }

    function meterValue(){
      if (analyser && data){
        analyser.getByteTimeDomainData(data);
        let sum = 0;
        for (let i=0;i<data.length;i++){ const v=(data[i]-128)/128; sum += v*v; }
        const rms = Math.sqrt(sum / data.length);
        return Math.min(100, Math.floor(rms*180));
      }
      // fallback אמין
      return Math.min(100, (Math.random()*65+20)|0);
    }

    function loop(){
      meter.style.width = meterValue() + '%';
      time.textContent = fmt(performance.now() - t0);
      raf = requestAnimationFrame(loop);
    }

    async function start(){
      try{sfx('confirm')}catch(e){}
      recording = true;
      label.textContent = 'Stop recording';
      btn.classList.remove('blue'); btn.classList.add('red');
      errEl.textContent = '';

      t0 = performance.now();
      loop();

      // נסיון הרשאת מיקרופון ל‑VU אמיתי (ללא הקלטה/שמירה)
      try{
        stream = await navigator.mediaDevices?.getUserMedia?.({ audio:true }) || null;
        if (stream){
          audioCtx = new (window.AudioContext||window.webkitAudioContext)();
          const src = audioCtx.createMediaStreamSource(stream);
          analyser = audioCtx.createAnalyser();
          analyser.fftSize = 1024;
          data = new Uint8Array(analyser.frequencyBinCount);
          src.connect(analyser);
        }
      }catch(_){ /* אין הרשאה – נשאר עם fallback */ }

      // fail-safe: עצירה אוטומטית אחרי 7ש׳׳ אם לא עצרו ידנית
      autoStop = window.setTimeout(()=>{ if(recording) stop(); }, 7000);
    }

    function cleanupAudio(){
      try{ stream?.getTracks?.().forEach(t=>t.stop()); }catch(_){}
      try{ audioCtx?.close?.(); }catch(_){}
      stream = null; audioCtx = null; analyser = null; data = null;
    }

    function stop(){
      try{sfx('click')}catch(e){}
      recording = false;
      label.textContent = 'Start recording';
      btn.classList.remove('red'); btn.classList.add('blue');

      window.clearTimeout(autoStop);
      cancelAnimationFrame(raf);
      cleanupAudio();

      attempt += 1;

      if (attempt === 1){
        // שגיאה אמינה בפעם הראשונה
        toast.classList.add('show');
        btn.classList.add('shake'); wrap.classList.add('shake');
        try{sfx('error')}catch(e){}
        setTimeout(()=>{ btn.classList.remove('shake'); wrap.classList.remove('shake'); }, 380);
        time.textContent = '00:00';
        meter.style.width = '0%';
        return;
      }
      if (attempt === 2){
  // שגיאה שנייה ואחרונה (טוסט #2)
  toast2.classList.add('show');
  btn.classList.add('shake'); wrap.classList.add('shake');
  try{sfx('error')}catch(e){}
  setTimeout(()=>{ btn.classList.remove('shake'); wrap.classList.remove('shake'); }, 380);
  time.textContent = '00:00';
  meter.style.width = '0%';
  return;
}
      // נסיון שלישי — הצלחה
try{sfx('tada')}catch(e){}
screenSuccess(); // הקונפטי ירוץ רק במסך ההצלחה
    }

    btn.addEventListener('click', ()=>{ recording ? stop() : start(); });
  }

  // מסך הצלחה
  function screenSuccess(){
    app.innerHTML = `
      <div class="wrap wrap-voice">
        <h1 class="vv-title">${copy.okTitle}</h1>
        <p class="vv-sub">${copy.okSub}</p>
        <button id="vv-open" class="btn green">${copy.okBtn}</button>
        ${ PREV ? `<div class="vv-sub">Preview only — button disabled</div>` : `` }
        <canvas id="vv-confetti" class="confetti-canvas"></canvas>
      </div>
    `;
    const btn = document.getElementById('vv-open');
    const canvas = document.getElementById('vv-confetti');
    confettiBurst(canvas);

    btn.addEventListener('click', ()=>{
      if(PREV) return;
      try{sfx('confirm')}catch(e){}
      try{ window.open(GIFT, '_blank', 'noopener'); }catch(e){}
    });
  }

  // GO
  screenIntro();
}

// ===== Fake Captcha =====
function captcha(){
  const qs    = new URLSearchParams(location.search);
  const PREV  = (qs.get('preview')||'0').trim()==='1';
  const NAME  = (qs.get('name')||'Friend').trim();
  const GIFT  = (qs.get('giftUrl')||'#').trim();

  const copy = {
    introTitle:  (qs.get('introTitle') || `A special gift is waiting for you, ${NAME}!`).slice(0,80),
    introSub:    (qs.get('introSub')   || `To unlock it, please verify your identity`).slice(0,80),
    introBtn:    (qs.get('introBtn')   || `Verify & get the gift`).slice(0,32),
    gridHeader:  (qs.get('gridHeader') || `Select all images with a weirdo 👇`).slice(0,80),
    verify:      (qs.get('verifyText') || `Verify`).slice(0,32),
    continueTxt: (qs.get('continueText') || `Success! get your gift`).slice(0,32),
    okTitle:     (qs.get('okTitle')    || `You're verified! 🤣`).slice(0,80),
    okSub:       (qs.get('okSub')      || `Enjoy your gift!`).slice(0,80),
    okBtn:       (qs.get('okBtn')      || `Claim your gift`).slice(0,32),
  };

  // שלושת היעדים הקבועים (0..8): ימני‑עליון, מרכז, תחתון‑מרכז
  const targets = [2,4,7];  // לפי הבריף. :contentReference[oaicite:4]{index=4}

  // העלאות מה‑URL (img1..img3)
  const IMG_URLS = [ qs.get('img1')||'', qs.get('img2')||'', qs.get('img3')||'' ];
  const anyProvided = IMG_URLS.some(Boolean);

  // 6 תמונות קבועות (מוקטנות ל‑600×600 עבור ביצועים)
  const FILLER_URLS = [
    "https://images.pexels.com/photos/1072179/pexels-photo-1072179.jpeg?auto=compress&cs=tinysrgb&w=600&h=600&dpr=2",
    "https://images.pexels.com/photos/113338/pexels-photo-113338.jpeg?auto=compress&cs=tinysrgb&w=600&h=600&dpr=2",
    "https://images.pexels.com/photos/38136/pexels-photo-38136.jpeg?auto=compress&cs=tinysrgb&w=600&h=600&dpr=2",
    "https://images.pexels.com/photos/70365/forest-sunbeams-trees-sunlight-70365.jpeg?auto=compress&cs=tinysrgb&w=600&h=600&dpr=2",
    "https://images.pexels.com/photos/1666021/pexels-photo-1666021.jpeg?auto=compress&cs=tinysrgb&w=600&h=600&dpr=2",
    "https://images.pexels.com/photos/1547813/pexels-photo-1547813.jpeg?auto=compress&cs=tinysrgb&w=600&h=600&dpr=2"
  ];

  // Placeholder גדול, בולד, שתי שורות (קריא במובייל)
  function placeholderDataURL(){
    const svg =
      `<svg xmlns='http://www.w3.org/2000/svg' width='600' height='600'>
         <rect width='100%' height='100%' fill='white'/>
         <g fill='#111' font-family='system-ui,Segoe UI,Roboto,Helvetica,Arial' font-weight='700'>
           <text x='50%' y='45%' text-anchor='middle' font-size='56'>The victim</text>
           <text x='50%' y='60%' text-anchor='middle' font-size='56'>goes here 🤣</text>
         </g>
       </svg>`;
    return 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(svg);
  }
  const PLACEHOLDER = placeholderDataURL();

  // מזער תמונות לרשת (Cloudinary/Pexels)
  function sizeForGrid(src){
    try{
      const u = new URL(src);
      if (/res\.cloudinary\.com/.test(u.hostname)) {
        return src.replace('/upload/', '/upload/f_auto,q_auto,w_600,h_600,c_fill/');
      }
      if (/images\.pexels\.com/.test(u.hostname)) {
        u.searchParams.set('auto','compress');
        u.searchParams.set('cs','tinysrgb');
        u.searchParams.set('w','600'); u.searchParams.set('h','600');
        u.searchParams.set('dpr', (window.devicePixelRatio||1) > 1 ? '2' : '1');
        return u.toString();
      }
      return src;
    }catch(e){ return src; }
  }

  // ב‑PREVIEW: אם חסרה תמונה – placeholder; בלייב: משכפלים אם פחות מ‑3
  function getTargetSrc(slotIndex){
    if (IMG_URLS[slotIndex]) return IMG_URLS[slotIndex];
    if (PREV || !anyProvided) return PLACEHOLDER;
    const present = IMG_URLS.filter(Boolean);
    return present[(slotIndex % present.length)] || PLACEHOLDER;
  }

  const nonTargets = [0,1,3,5,6,8];

  const app = document.getElementById('app');
  app.classList.remove('card'); // “מסך נקי” כמו infinite. :contentReference[oaicite:5]{index=5}

  function screenIntro(){
    app.innerHTML = `
      <div class="wrap wrap-captcha">
        <h1 class="cap-title">${copy.introTitle}</h1>
        <p class="cap-sub">${copy.introSub}</p>
        <button id="start" class="btn cap-cta">${copy.introBtn}</button>
        <div class="cap-hint">no data will be collected</div>
      </div>
    `;
    document.getElementById('start').addEventListener('click', ()=>{ try{sfx('confirm')}catch(e){}; screenGrid(); });
  }

  function tileHtml(i){
    const ti = targets.indexOf(i);
    if (ti !== -1){
      const src = sizeForGrid(getTargetSrc(ti));
      return `<div class="cap-tile" data-i="${i}"><img class="cap-img" src="${src}" alt="" decoding="async"></div>`;
    }
    const k = nonTargets.indexOf(i);
    const src = sizeForGrid(FILLER_URLS[k] || PLACEHOLDER);
    return `<div class="cap-tile" data-i="${i}"><img class="cap-img" src="${src}" alt="" decoding="async"></div>`;
  }

  function screenGrid(){
    app.innerHTML = `
      <div class="wrap wrap-captcha">
        <h1 class="cap-title">${copy.gridHeader}</h1>
        <div id="grid" class="cap-grid">
          ${Array.from({length:9}).map((_,i)=>tileHtml(i)).join('')}
        </div>
        <button id="verify" class="btn cap-cta">${copy.verify}</button>
        ${PREV ? `<div class="cap-hint">Preview mode</div>` : ``}
        <canvas id="cap-confetti" class="confetti-canvas"></canvas>
      </div>
    `;

    const grid = document.getElementById('grid');
    const verifyBtn = document.getElementById('verify');
    const confettiCanvas = document.getElementById('cap-confetti');

    // Tap מיידי במקום click
    grid.addEventListener('pointerdown', (e)=>{
      const tile = e.target.closest('.cap-tile');
      if(!tile) return;
      tile.classList.toggle('sel');
    });

    let solved = false;

    verifyBtn.addEventListener('click', ()=>{
      if(solved){ screenSuccess(); return; }
      const selected = [...grid.querySelectorAll('.cap-tile.sel')].map(t=>+t.dataset.i).sort((a,b)=>a-b);
      const ok = JSON.stringify(selected) === JSON.stringify([...targets].sort((a,b)=>a-b)); // בדיוק 3 היעדים. :contentReference[oaicite:6]{index=6}
      if(!ok){
        try{sfx('error')}catch(e){}
        verifyBtn.classList.add('error'); grid.classList.add('shake');
        setTimeout(()=>{ verifyBtn.classList.remove('error'); grid.classList.remove('shake'); }, 380);
        return;
      }
      try{sfx('tada')}catch(e){}
      confettiBurst(confettiCanvas);
      verifyBtn.textContent = copy.continueTxt;
      verifyBtn.classList.add('green');
      solved = true;
    });
  }

  function screenSuccess(){
    app.innerHTML = `
      <div class="wrap wrap-captcha">
        <h1 class="cap-title">${copy.okTitle}</h1>
        <p class="cap-sub">${copy.okSub}</p>
        <button id="openGift" class="btn cap-cta green">${copy.okBtn}</button>
        ${PREV ? `<div class="cap-hint">Preview only — button disabled</div>` : ``}
      </div>
    `;
    const btn = document.getElementById('openGift');
    btn.addEventListener('click', ()=>{
      if(PREV) return;
      try{sfx('confirm')}catch(e){}
      try{ window.open(GIFT, '_blank', 'noopener'); }catch(e){}
    });
  }

  // קונפטי
  function confettiBurst(canvas){
    if(!canvas) return;
    const ctx = canvas.getContext('2d');
    const r = window.devicePixelRatio || 1;
    function size(){ canvas.width = canvas.clientWidth * r; canvas.height = canvas.clientHeight * r; ctx.setTransform(r,0,0,r,0,0); }
    if(!canvas.__sized){ canvas.__sized = true; canvas.style.display='block'; size(); window.addEventListener('resize', size); }
    const colors = ['#a78bfa','#60a5fa','#34d399','#f472b6','#f59e0b'];
    const pieces = [];
    const w = canvas.clientWidth, h = canvas.clientHeight;
    for(let i=0;i<120;i++){
      pieces.push({ x:w/2, y:h/2, vx:(Math.random()*4-2), vy:(Math.random()*-3-2),
        r:Math.random()*6+3, c:colors[(Math.random()*colors.length)|0], a:1, spin:(Math.random()*6.28), vr:(Math.random()*0.2-0.1) });
    }
    const g = 0.05; let t=0;
    (function step(){
      ctx.clearRect(0,0,w,h);
      pieces.forEach(p=>{
        p.vy += g; p.x += p.vx; p.y += p.vy; p.spin += p.vr; p.a -= 0.008;
        ctx.globalAlpha = Math.max(p.a,0);
        ctx.save(); ctx.translate(p.x,p.y); ctx.rotate(p.spin);
        ctx.fillStyle = p.c; ctx.fillRect(-p.r/2,-p.r/2,p.r,p.r);
        ctx.restore();
      });
      ctx.globalAlpha = 1;
      if(t++<260) requestAnimationFrame(step); else ctx.clearRect(0,0,w,h);
    })();
  }

  // GO
  screenIntro();
}
  
// ===== Infinite Buttons =====
function infinite(){
  const app = document.getElementById('app');

  // Read params
  const NAME = getCopy('name', 'Friend');
  const GIFT = qs.get('giftUrl') || 'https://example.com';
  const ACCENT = (qs.get('accent') || 'dark').toLowerCase();
  const titleOverride = qs.get('title');

  const copy = {
    title: titleOverride ? titleOverride : `${NAME}, you've got a sweet surprise! 💖`,
    subtitle: getCopy('subtitle', 'Click the button to get your gift'),
    btn1_loading: getCopy('btn1_loading', 'Loading... hold on'),
    btn2_error: getCopy('btn2_error', 'Oops! Try again'),
    btn3_tease1: getCopy('btn3_tease1', 'Error! Click again'),
    btn4_tease2: getCopy('btn4_tease2', 'Try to click harder'),
    btn5_tease3: getCopy('btn5_tease3', 'You love being trolled?'),
    btn6_tease4: getCopy('btn6_tease4', 'Admit it, this is fun 😈'),
    btn7_tease5: getCopy('btn7_tease5', 'Almost there... or not? 🤭'),
    btn8_success: getCopy('btn8_success', 'Unlocked! Tap to open'),
    earned: getCopy('earned', 'You earned it 🎉')
  };

  // Inner block
  const inner = document.createElement('div');
  inner.className = 'wrap wrap-infinite';
  inner.innerHTML = `
    <h1>${copy.title}</h1>
    <p class="sub">${copy.subtitle}</p>

    <button id="ibtn" class="btn">
      <span id="ilabel" class="label">${getCopy('btn0_start','Claim your gift')}</span>
      <span id="ipct" class="percent" style="display:none">0%</span>
    </button>

    <div id="iprogress" class="progress" aria-hidden="true" style="display:none">
      <div class="progress__bar" id="ibar"></div>
    </div>

    <div id="earned" class="earned">${copy.earned}</div>
    <canvas id="confetti" class="confetti-canvas"></canvas>
  `;
  app.replaceChildren(inner);
  document.getElementById('app').classList.remove('card');

  // Refs
  const btn = document.getElementById('ibtn');
  const ilabel = document.getElementById('ilabel');
  const ipct = document.getElementById('ipct');
  const bar = document.getElementById('ibar');
  const progWrap = document.getElementById('iprogress');
  const earned = document.getElementById('earned');
  const confettiCanvas = document.getElementById('confetti');

  // helpers for fun states
  function resetBtnColors(){
    btn.classList.remove('error','purple','sky','green','alt1','alt2','success');
  }
  function resetFx(){
    inner.classList.remove('shake','fx-alert','fx-calm','fx-blue','fx-pink');
  }

  // state
  let tap = 0;
  let loading = false;
  let success = false;
  btn.disabled = false;
  let interval = null;

  function startLoading(){
    loading = true;
    btn.disabled = true;
    sfx('confirm');

    progWrap.style.display = 'block';
    ipct.style.display = 'inline';
    ipct.textContent = '0%';
    bar.style.width = '0%';

    let p = 0;
    interval = setInterval(()=>{
      p = Math.min(100, p + Math.floor(Math.random()*7)+2);
      bar.style.width = p + '%';
      ipct.textContent = p + '%';

      if (p >= 100){
        clearInterval(interval);
        setTimeout(()=>{
  ipct.style.display = 'none';
  btn.disabled = false;
  loading = false;
  // מעבר אוטומטי לשלב הבא (Oops) בלי קליק נוסף
  if (tap === 1) { btn.click(); }
}, 300);
      }
    }, 120);
  }

  function openGift(){
    try { window.open(GIFT, '_blank', 'noopener'); } catch(e) {}
  }

  btn.addEventListener('click', function(){
    if (success) { openGift(); return; }

    if (tap === 0){
      ilabel.textContent = copy.btn1_loading;
      if (!interval) startLoading();
      tap = 1;
      return;
    }
    if (loading) return;

    tap++;

    switch (tap) {
      case 2: {
        ilabel.textContent = copy.btn2_error;
        resetBtnColors(); btn.classList.add('error'); sfx('error');
        inner.classList.add('shake'); setTimeout(()=> inner.classList.remove('shake'), 300);
        break;
      }
      case 3: {
  ilabel.textContent = copy.btn3_tease1;
  resetBtnColors(); btn.classList.add('alt1'); resetFx();
  inner.classList.add('shake'); setTimeout(()=> inner.classList.remove('shake'), 300);
  break;
}
      case 4: {
  ilabel.textContent = copy.btn4_tease2;
  resetBtnColors(); btn.classList.add('alt2'); resetFx();
  break;
}
      case 5: {
  ilabel.textContent = copy.btn5_tease3;
  resetBtnColors(); btn.classList.add('alt1'); resetFx();
  sfx('whoosh');
  break;
}
      case 6: {
  ilabel.textContent = copy.btn6_tease4;
  resetBtnColors(); btn.classList.add('alt2'); resetFx();
  break;
}
      case 7: {
  ilabel.textContent = copy.btn7_tease5;
  resetBtnColors(); btn.classList.add('alt1'); resetFx();
  sfx('whoosh');
  break;
}
      case 8: {
        ilabel.textContent = copy.btn8_success;
        resetBtnColors(); btn.classList.add('green'); // או .success אם הוספת CSS
        earned.classList.add('show');
        confettiBurst(confettiCanvas);
        sfx('tada');
        success = true;
        break;
      }
      default: {
        openGift();
      }
    }
  }, false);

  // Canvas confetti (modern "poof")
  function confettiBurst(canvas){
    if (!canvas) return;
    const ctx = canvas.getContext('2d');
    const r = window.devicePixelRatio || 1;
    function size(){ canvas.width = canvas.clientWidth * r; canvas.height = canvas.clientHeight * r; ctx.setTransform(r,0,0,r,0,0); }
    if (!canvas.__sized){ canvas.__sized = true; canvas.style.display='block'; size(); window.addEventListener('resize', size); }
    const colors = ['#a78bfa','#60a5fa','#34d399','#f472b6','#f59e0b'];
    const pieces = [];
    const w = canvas.clientWidth, h = canvas.clientHeight;
    for(let i=0;i<120;i++){
      pieces.push({ x:w/2, y:h/2, vx:(Math.random()*4-2), vy:(Math.random()*-3-2),
        r:Math.random()*6+3, c:colors[(Math.random()*colors.length)|0], a:1, spin:(Math.random()*6.28), vr:(Math.random()*0.2-0.1) });
    }
    const g = 0.05; let t=0;
    (function step(){
      ctx.clearRect(0,0,w,h);
      pieces.forEach(p=>{
        p.vy += g; p.x += p.vx; p.y += p.vy; p.spin += p.vr; p.a -= 0.008;
        ctx.globalAlpha = Math.max(p.a,0);
        ctx.save(); ctx.translate(p.x,p.y); ctx.rotate(p.spin);
        ctx.fillStyle = p.c; ctx.fillRect(-p.r/2,-p.r/2,p.r,p.r);
        ctx.restore();
      });
      ctx.globalAlpha = 1;
      if(t++<260) requestAnimationFrame(step); else ctx.clearRect(0,0,w,h);
    })();
  }
}
// ===== Narcissist Questions =====
function narcissistQ(){
  // Params
  const qs    = new URLSearchParams(location.search);
  const PREV  = (qs.get('preview')||'0').trim()==='1';
  const NAME  = (qs.get('name')||'Friend').trim().slice(0,24);
  const GIFT  = (qs.get('giftUrl')||'#').trim();
  const ACCENT= (qs.get('accent')||'dark').trim().toLowerCase(); // optional: dark|blue|green|purple

  // Style (scoped)
  if(!document.getElementById('nq-css')){
    document.head.insertAdjacentHTML('beforeend', `
      <style id="nq-css">
        .wrap-nq{ display:grid; gap:24px; justify-items:center; text-align:center; margin-top:clamp(12px,6vh,48px) }
        .nq-title{ margin:0; font-size:26px; line-height:1.25; font-weight:800 }
        .nq-sub{ margin:0; font-size:15px; color:#9aa3b2 }
        .nq-steps{ font-size:12px; color:#9aa3b2; opacity:.9 }
        .nq-grid{ display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:10px; width:min(360px,100%) }
        @media (max-width:380px){ .nq-grid{ grid-template-columns:1fr } }
        .nq-card{
          position:relative; border-radius:14px; padding:14px 12px; text-align:left; cursor:pointer;
          background:rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.10);
          transition:transform .055s ease, box-shadow .12s ease, border-color .12s ease, background .12s ease;
          touch-action:manipulation; -webkit-tap-highlight-color:transparent; user-select:none;
        }
        .nq-card:hover{ transform:translateY(-1px); box-shadow:0 10px 24px rgba(0,0,0,.25) }
        .nq-card:active{ transform:translateY(0) scale(.995) }
        .nq-letter{ display:inline-block; font-weight:900; font-size:12px; color:#9aa3b2; margin-right:6px }
        .nq-text{ font-size:15px; }
        /* fix: readable text on dark cards */
.nq-card{ color:#e8ecf4; }   /* טקסט בהיר לכל הכרטיס */
.nq-text{ color:inherit; }   /* לוודא שה-span יורש את הבהיר */
        .nq-card.ok{ box-shadow:0 10px 28px rgba(16,185,129,.25); border-color:rgba(16,185,129,.45) }
        .nq-card.err{ box-shadow:0 10px 28px rgba(239,68,68,.25); border-color:rgba(239,68,68,.55); background:linear-gradient(0deg,rgba(239,68,68,.10),transparent) }
        .nq-toast{ font-size:12px; color:#9aa3b2; min-height:16px }
        .nq-hint{ font-size:12px; color:#9aa3b2 }
        .nq-green{ background:#10b981 !important; color:#fff !important }
        .nq-btn{ width:min(320px,100%); min-height:48px; padding:14px 18px; font-size:16px; border-radius:16px; font-weight:800 }
        .nq-confetti{ position:fixed; inset:0; pointer-events:none; z-index:999; display:block }
        /* Accent (optional) */
        .nq-theme-blue .nq-card:hover{ border-color:#38bdf8 }
        .nq-theme-purple .nq-card:hover{ border-color:#a78bfa }
        .nq-theme-green .nq-card:hover{ border-color:#10b981 }
      </style>
    `);
  }

  // Remove "card chrome" for clean runtime
  const app = document.getElementById('app');
  app.classList.remove('card');

  // Copy / defaults (from brief)
  const copy = {
    introTitle: (qs.get('introTitle') || `${NAME}, you've got a sweet gift!`).slice(0,80),
    introSub:   (qs.get('introSub')   || `To claim it, answer 3 quick questions.`).slice(0,80),
    startBtn:   (qs.get('startBtn')   || `Verify identity to get the gift`).slice(0,40),
    okTitle:    (qs.get('okTitle')    || `You've earned it 🤣`).slice(0,80),
    okSub:      (qs.get('okSub')      || `You're officially verified.`).slice(0,80),
    okBtn:      (qs.get('okBtn')      || `Get the real gift`).slice(0,40),
  };

  // Defaults per the brief (escape defaults to D)
  const defaults = [
    { q:`Why am I the main character today?`,
      a:`Because you're iconic`, b:`Remember that legendary trip?`, c:`Your charm is undefeatable`,
      d:`Just give me the gift already! 😂`, esc:'d' },
    { q:`You’ll name your kid after me because…`,
      a:`I’m a genius`, b:`Obviously—I’m iconic`, c:`You adore me`,
      d:`Set me free already!`, esc:'d' },
    { q:`One word that best describes me:`,
      a:`Legend`, b:`Masterpiece`, c:`Unforgettable`,
      d:`Skip to the gift`, esc:'d' }
  ];

  function take(n,k,fb){ return (qs.get(`q${n}${k}`) || fb).toString().slice(0,80) }
  function getQ(n){
    const def = defaults[n-1];
    let esc = (qs.get(`q${n}esc`) || qs.get(`esc${n}`) || def.esc || 'd').toLowerCase();
    if(!['a','b','c','d'].includes(esc)) esc='d';
    return {
      q: take(n,'', def.q),
      a: take(n,'a', def.a),
      b: take(n,'b', def.b),
      c: take(n,'c', def.c),
      d: take(n,'d', def.d),
      esc
    };
  }
  const Q = [getQ(1), getQ(2), getQ(3)];

  // Accent class on wrapper
  const themeClass = (ACCENT==='blue')?'nq-theme-blue':(ACCENT==='green')?'nq-theme-green':(ACCENT==='purple')?'nq-theme-purple':'';

  // Render helpers
  function render(html){ app.innerHTML = html; }

  function toast(el, text){ if(!el) return; el.textContent = text||''; }

  function confettiBurst(){
    // Canvas confetti (like in other features)
    const canvas = document.createElement('canvas');
    canvas.className = 'nq-confetti';
    document.body.appendChild(canvas);
    const ctx = canvas.getContext('2d');
    const r = window.devicePixelRatio||1;
    function size(){ canvas.width = innerWidth*r; canvas.height = innerHeight*r; ctx.setTransform(r,0,0,r,0,0); }
    size(); const onR=()=>size(); window.addEventListener('resize', onR, { once:true });
    const colors=['#a78bfa','#60a5fa','#34d399','#f472b6','#f59e0b'];
    const pieces=[]; const w=innerWidth, h=innerHeight;
    for(let i=0;i<140;i++){
      pieces.push({ x:w/2, y:h/2, vx:(Math.random()*4-2), vy:(Math.random()*-3-2),
        r:Math.random()*6+3, c:colors[(Math.random()*colors.length)|0], a:1, spin:(Math.random()*6.28), vr:(Math.random()*0.2-0.1) });
    }
    const g=0.05; let t=0;
    (function step(){
      ctx.clearRect(0,0,w,h);
      pieces.forEach(p=>{
        p.vy+=g; p.x+=p.vx; p.y+=p.vy; p.spin+=p.vr; p.a-=0.008;
        ctx.globalAlpha=Math.max(p.a,0);
        ctx.save(); ctx.translate(p.x,p.y); ctx.rotate(p.spin);
        ctx.fillStyle=p.c; ctx.fillRect(-p.r/2,-p.r/2,p.r,p.r);
        ctx.restore();
      });
      ctx.globalAlpha=1;
      if(t++<260) requestAnimationFrame(step); else { ctx.clearRect(0,0,w,h); canvas.remove(); }
    })();
  }

  function screenIntro(){
    render(`
      <div class="wrap wrap-nq ${themeClass}">
        <h1 class="nq-title">${copy.introTitle}</h1>
        <p class="nq-sub">${copy.introSub}</p>
        <button id="nqStart" class="btn nq-btn">${copy.startBtn}</button>
        <div class="nq-hint">no data collected</div>
      </div>
    `);
    document.getElementById('nqStart')?.addEventListener('click', ()=>{ try{sfx('confirm')}catch(_){ } screenQ(1); });
  }

  function qCard(letter, text){
    return `<button class="nq-card" data-letter="${letter}">
      <span class="nq-letter">${letter.toUpperCase()}</span>
      <span class="nq-text">${text}</span>
    </button>`;
  }

  function screenQ(i){
    const d = Q[i-1];
    render(`
      <div class="wrap wrap-nq ${themeClass}">
        <div class="nq-steps">Question ${i} of 3</div>
        <h1 class="nq-title">${d.q}</h1>
        <div class="nq-grid" id="nqGrid">
          ${qCard('a', d.a)}
          ${qCard('b', d.b)}
          ${qCard('c', d.c)}
          ${qCard('d', d.d)}
        </div>
        <div class="nq-toast" id="nqToast"></div>
        ${PREV ? `<div class="nq-hint">Preview mode</div>` : ``}
      </div>
    `);

    const grid = document.getElementById('nqGrid');
    const tip  = document.getElementById('nqToast');
    grid.addEventListener('pointerdown', (e)=>{
      const card = e.target.closest('.nq-card'); if(!card) return;
      const letter = card.getAttribute('data-letter');
      if(letter === d.esc){
        try{sfx('error')}catch(_){}
        card.classList.add('err','shake'); toast(tip, 'Oops, try again!');
        setTimeout(()=> card.classList.remove('shake'), 350);
      } else {
        card.classList.add('ok');
        setTimeout(()=>{ if(i<3) screenQ(i+1); else screenSuccess(); }, 180);
      }
    }, { passive:true });
  }

  function screenSuccess(){
    render(`
      <div class="wrap wrap-nq ${themeClass}">
        <h1 class="nq-title">${copy.okTitle}</h1>
        <p class="nq-sub">${copy.okSub}</p>
        <button id="nqOpen" class="btn nq-btn nq-green"${PREV?' disabled':''}>${copy.okBtn}</button>
        ${PREV ? `<div class="nq-hint">Preview only — button disabled</div>` : ``}
      </div>
    `);
    try{sfx('tada')}catch(_){}
    confettiBurst();
    const btn = document.getElementById('nqOpen');
    btn?.addEventListener('click', ()=>{
      if(PREV) return;
      try{sfx('confirm')}catch(_){}
      try{ window.open(GIFT, '_blank', 'noopener'); }catch(_){}
    });
  }

  screenIntro();
}
  
// ===== Selfie Verify =====
function selfieVerify(){
  // --- 0) One-time style injection (overrides layout to centered + RTL, adds overlay/success tweaks) ---
  (function injectCSS(){
    if (document.getElementById('selfie-ux-extra')) return;
    const css = `
      /* מרכזים אנכית בתוך ה"טלפון" + RTL */
#app .wrap-selfie{
  display:grid;
  gap:24px;
  justify-items:center;
  text-align:center;
  direction:rtl;
  margin-top: clamp(12px, 6vh, 48px); /* זהה ל-infinite */
}
      #app .sf-status, #app .sf-row{ direction:rtl }

      /* Overlay countdown (blur background) */
      .sf-overlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;
        background:rgba(0,0,0,.55);backdrop-filter:blur(6px);z-index:1000;text-align:center;padding:24px}
      .sf-overlay.on{display:flex}
      .sf-count{font-size:96px;font-weight:900;line-height:1}
      .sf-sub2{font-size:14px;color:#cbd5e1;margin-top:12px}

      /* Success screen (title + big check + image card) */
      .sf-topline{display:flex;align-items:center;gap:10px;justify-content:center}
      .sf-topline .check{font-size:28px;color:#10b981}
      .sf-monkey{
        width:min(360px,100%);aspect-ratio:1/1;overflow:hidden;border-radius:16px;
        border:1px solid rgba(255,255,255,.10);background:#0f1324;display:flex;align-items:center;justify-content:center
      }
      .sf-monkey img{width:100%;height:100%;object-fit:cover;user-select:none;-webkit-user-drag:none}
      /* LED ring around the monkey image */
.sf-monkey{ position:relative; } /* חשוב כדי שאפשר יהיה למקם את ה-LED */
.sf-monkey::after{
  content:"";
  position:absolute; inset:-2px; border-radius:inherit; padding:2px;
  background:
    conic-gradient(from 0deg,
      #a78bfa 0 12deg, transparent 12deg 20deg,
      #60a5fa 20deg 32deg, transparent 32deg 40deg,
      #34d399 40deg 52deg, transparent 52deg 60deg,
      #f59e0b 60deg 72deg, transparent 72deg 80deg,
      #f472b6 80deg 92deg, transparent 92deg 100deg,
      #a78bfa 100deg 112deg, transparent 112deg 120deg);
  /* מציג רק טבעת דקה מסביב (חיתוך פנימי) */
  -webkit-mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
  -webkit-mask-composite: xor;
          mask-composite: exclude;
  pointer-events:none;
  animation: ledSpin .9s linear infinite; /* מהירות "משוגעת" ונעימה */
}
@keyframes ledSpin { to { transform: rotate(1turn); } }

/* Zoom-in עדין לתמונה כשהמסך נטען */
.sf-monkey img{ transform:scale(1); transition:transform .6s cubic-bezier(.2,.9,.2,1); }
.sf-monkey img.pop{ transform:scale(1.08); }

      .btn{appearance:none;border:0;border-radius:12px;padding:12px 14px;font-weight:800;cursor:pointer}
      .green{background:#10b981;color:#fff}
      .ghost{background:#0b1020;color:#9aa3b2;border:1px solid rgba(255,255,255,.12)}
      .sf-cta{width:min(320px,100%);min-height:48px;padding:14px 18px;font-size:16px;border-radius:16px;font-weight:800;margin:0 auto}
    `;
    const st = document.createElement('style');
    st.id = 'selfie-ux-extra';
    st.textContent = css;
    (document.head || document.documentElement).appendChild(st);
  })();

  // --- 1) Read params & setup (Runtime contract) ---
  const qs    = new URLSearchParams(location.search);
  const PREV  = (qs.get('preview')||'0').trim()==='1';
  const NAME  = (qs.get('name')||'Friend').trim();
  const GIFT  = (qs.get('giftUrl')||'#').trim();
  const app   = document.getElementById('app');
  app.classList.remove('card');  // מסך נקי כפי שמוגדר בשלד.  (Runtime)  [ref]
  // (השלד והחוזים: מיפוי slug→פונקציה, רינדור לתוך #app בלבד)  // :contentReference[oaicite:3]{index=3}

  // טקסטים (+ חדשים)
  const copy = {
    introTitle:   (qs.get('introTitle')  || `${NAME}, a special gift is waiting! 🎁`).slice(0,80),
    introSub:     (qs.get('introSub')    || `To claim it, please verify your identity with a quick selfie.`).slice(0,80),
    introBtn:     (qs.get('introBtn')    || `Start selfie verification`).slice(0,32),

    camLabel:     (qs.get('camLabel')    || `המצלמה פועלת — ודא/י שהפנים במרכז המסגרת`).slice(0,60),
    captureBtn:   (qs.get('captureBtn')  || `לצילום ואימות זהותך`).slice(0,32),
    overlaySub:   (qs.get('overlaySub')  || `אנא אמתן בזמן שהמערכת מאמתת את זהותך…`).slice(0,80),

    successTitle: (qs.get('successTitle')|| `זהותך אומתה בהצלחה!`).slice(0,60),
    okSub:        (qs.get('okSub')       || `You’re good to go.`).slice(0,80),
    giftBtn:      (qs.get('giftBtn')     || qs.get('okBtn') || `לקבלת המתנה האמיתית`).slice(0,32),
    saveBtn:      (qs.get('saveBtn')     || `לשמירת התמונה`).slice(0,24)
  };

  // פילטרים מצחיקים (כמו בבריף)
const filterPreset = (qs.get('filter') || 'none').toLowerCase();
const fxClass = ['ugly1','ugly2','ugly3','none'].includes(filterPreset) ? `fx-${filterPreset}` : 'fx-none';

  // סט ברירת־מחדל של תמונות הקוף – הקישורים שסיפקת
  const DEFAULT_MONKEYS = [
    "https://i.pinimg.com/736x/04/cc/d5/04ccd55d5944df4195eccd126f729499.jpg",
    "https://www.stockvault.net/data/2009/07/27/109625/preview16.jpg",
    "https://e0.pxfuel.com/wallpapers/515/782/desktop-wallpaper-ugly-monkey-ugly-face.jpg",
    "https://www.stockvault.net/data/2020/10/19/280001/preview16.jpg"
  ];
  // מאפשר גם לעקוף דרך פרמטרים ?monkey1..monkey5
  const MONKEY_OVR = [1,2,3,4,5].map(i => (qs.get('monkey'+i)||'').trim()).filter(Boolean);
  const MONKEYS = (MONKEY_OVR.length ? MONKEY_OVR : DEFAULT_MONKEYS);

  let stream = null;
  let lastShot = null; // dataURL של הסלפי (לריאליזם; לא שומרים/לא שולחים)

  function stopCamera(){ try{ stream?.getTracks?.().forEach(t=>t.stop()); }catch(_){ } stream=null; }

  // קונפטי (כמו בשאר הפיצ'רים)
  function confettiBurst(canvas){
    if(!canvas) return;
    const ctx = canvas.getContext('2d');
    const r   = devicePixelRatio || 1;
    function size(){ canvas.width = canvas.clientWidth * r; canvas.height = canvas.clientHeight * r; ctx.setTransform(r,0,0,r,0,0); }
    if(!canvas.__sized){ canvas.__sized = true; canvas.style.display='block'; size(); addEventListener('resize', size); }
    const colors=['#a78bfa','#60a5fa','#34d399','#f472b6','#f59e0b'];
    const pieces=[]; const w=canvas.clientWidth, h=canvas.clientHeight;
    for(let i=0;i<120;i++){
      pieces.push({x:w/2,y:h/2,vx:(Math.random()*4-2),vy:(Math.random()*-3-2),r:Math.random()*6+3,c:colors[(Math.random()*colors.length)|0],a:1,spin:(Math.random()*6.28),vr:(Math.random()*0.2-0.1)});
    }
    const g=0.05; let t=0;
    (function step(){
      ctx.clearRect(0,0,w,h);
      pieces.forEach(p=>{
        p.vy+=g; p.x+=p.vx; p.y+=p.vy; p.spin+=p.vr; p.a-=0.008;
        ctx.globalAlpha = Math.max(p.a,0);
        ctx.save(); ctx.translate(p.x,p.y); ctx.rotate(p.spin);
        ctx.fillStyle=p.c; ctx.fillRect(-p.r/2,-p.r/2,p.r,p.r);
        ctx.restore();
      });
      ctx.globalAlpha=1;
      if(t++<260) requestAnimationFrame(step); else ctx.clearRect(0,0,w,h);
    })();
  }

  // ---- 2) Screens ----
  function screenIntro(){
    app.innerHTML = `
      <div class="wrap wrap-selfie">
        <h1 class="sf-title">${copy.introTitle}</h1>
        <p class="sf-sub">${copy.introSub}</p>
        <button id="sfStart" class="btn sf-cta green">${copy.introBtn}</button>
        <div class="sf-hint">no data collected</div>
      </div>`;
    // אין צליל לחיצה כאן (לפי הבקשה)
    document.getElementById('sfStart').addEventListener('click', screenCamera, { once:true });
  }
function screenCamera(){
  stopCamera();
  app.innerHTML = `
    <div class="wrap wrap-selfie">
      <div id="cam" class="sf-cam ${fxClass}">
        <video id="sfVideo" autoplay playsinline muted></video>
        <div id="sfFallback" class="sf-fallback" hidden>
          Camera unavailable — using a fun fake frame 😅
        </div>
      </div>

      <div class="sf-status">
        <div class="sf-spinner"></div>
        <div id="sfLbl">${copy.camLabel}</div>
      </div>

      <div class="sf-row">
        <button id="sfCapture" class="btn sf-cta green">${copy.captureBtn}</button>
      </div>

      <canvas id="sfConfetti" class="confetti-canvas"></canvas>
      <div class="sf-hint">Camera feed isn’t saved</div>

      <!-- Overlay: big 5→1 on blurred background -->
      <div id="sfOverlay" class="sf-overlay" aria-hidden="true">
        <div>
          <div id="sfCount" class="sf-count">5</div>
          <div class="sf-sub2">${copy.overlaySub}</div>
        </div>
      </div>
    </div>`;

  const video    = document.getElementById('sfVideo');
  const fallback = document.getElementById('sfFallback');

  // Start camera (front) — robust + logs
startCamera(video, fallback);

// iOS/Safari nudge: אם הווידאו נעצר, נסה play() לאחר נגיעה ראשונה
const nudge = ()=>{ try{ video.play().catch(()=>{}); }catch(_){ } document.removeEventListener('pointerdown', nudge); };
document.addEventListener('pointerdown', nudge, { once:true });

  // ✅ כפתור “לצילום ואימות זהותך”
  document.getElementById('sfCapture').addEventListener('click', ()=>{
    lastShot = trySnapshot(video) || null;
    const ov = document.getElementById('sfOverlay');
    const n  = document.getElementById('sfCount');
    startOverlayCountdown(ov, n, 5, ()=>{
      try{sfx('tada')}catch(_){}
      screenSuccess();
    });
  });
}
   function screenSuccess(){
  stopCamera();
  const picked = (typeof MONKEYS!=='undefined' && MONKEYS.length)
    ? MONKEYS[Math.floor(Math.random()*MONKEYS.length)]
    : '';

  app.innerHTML = `
    <div class="wrap wrap-selfie">
      <div class="sf-topline">
        <span class="check">✔</span>
        <h1 class="sf-title" style="margin:0">${copy.successTitle}</h1>
      </div>
      <p class="sf-sub">${copy.okSub}</p>

      ${picked ? `<div class="sf-monkey"><img id="monkeyImg" src="${picked}" alt="funny ugly monkey"></div>` : ''}

      <div class="sf-row" style="margin-top:10px">
        <button id="sfOpen" class="btn sf-cta green"${PREV?' disabled':''}>${copy.giftBtn}</button>
        ${picked ? `<button id="sfSave" class="btn ghost">${copy.saveBtn}</button>` : ''}
      </div>

      ${PREV ? `<div class="sf-hint sf-phone-only">Preview only — green button disabled</div>` : ``}
      <canvas id="sfConfetti2" class="confetti-canvas"></canvas>
    </div>`;

  // קונפטי
  confettiBurst(document.getElementById('sfConfetti2'));
     const mImg = document.getElementById('monkeyImg');
if (mImg) setTimeout(()=> mImg.classList.add('pop'), 120);

  // כפתור ירוק
  document.getElementById('sfOpen').addEventListener('click', ()=>{
    if(PREV) return;
    try{sfx('confirm')}catch(_){}
    try{ window.open(GIFT, '_blank', 'noopener'); }catch(_){}
  });

  // כפתור שמירת התמונה (רק אם יש תמונה)
  const saveBtn = document.getElementById('sfSave');
  if (saveBtn){
    saveBtn.addEventListener('click', ()=>{
      const img = document.getElementById('monkeyImg');
      if(!img || !img.src) return;
      try{
        const a = document.createElement('a');
        a.href = img.src; a.download = 'ugly-monkey.jpg';
        a.target = '_blank'; a.rel = 'noopener';
        document.body.appendChild(a); a.click(); a.remove();
      }catch(_){
        try{ window.open(img.src, '_blank', 'noopener'); }catch(__){}
      }
    });
  }
}
  // ---- 3) Helpers ----
async function startCamera(videoEl, fallbackEl){
  if (!navigator.mediaDevices?.getUserMedia){
    fallbackEl.hidden = false;
    console.warn('[Selfie] camera: mediaDevices/getUserMedia missing (insecure context?)');
    return false;
  }
  const configs = [
    { video:{ facingMode:{ ideal:'user' }, width:{ ideal:1280 }, height:{ ideal:720 } }, audio:false },
    { video:{ facingMode:'user' }, audio:false },
    { video:true, audio:false }
  ];
  for (const c of configs){
    try{
      stream = await navigator.mediaDevices.getUserMedia(c);
      videoEl.srcObject = stream;
      // עוזר לאוטופליי/ספארי
      videoEl.setAttribute('playsinline',''); 
      videoEl.playsInline = true;
      videoEl.setAttribute('autoplay','');
      videoEl.muted = true;
      await videoEl.play().catch(()=>{});
      fallbackEl.hidden = true;
      return true;
    }catch(err){
      console.warn('[Selfie] getUserMedia failed:', err?.name, err?.message);
    }
  }
  fallbackEl.hidden = false;
  return false;
}

  function trySnapshot(videoEl){
    try{
      const vw = videoEl.videoWidth, vh = videoEl.videoHeight;
      if(!vw || !vh) return null;
      const c = document.createElement('canvas');
      c.width = vw; c.height = vh;
      const ctx = c.getContext('2d');
      ctx.drawImage(videoEl, 0, 0, vw, vh);
      return c.toDataURL('image/jpeg', .9);
    }catch(_){ return null; }
  }

  function startOverlayCountdown(overlayEl, numEl, from, done){
    overlayEl.classList.add('on');
    let n = Math.max(1, from|0);
    numEl.textContent = String(n);
    const t = setInterval(()=>{
      n -= 1;
      if(n<=0){
        clearInterval(t);
        overlayEl.classList.remove('on');
        done && done();
      }else{
        numEl.textContent = String(n);
      }
    }, 1000);
  }

  // ---- 4) Start flow + cleanup ----
  screenIntro();
  addEventListener('pagehide', stopCamera);
}

// ===== Shake (MOBILE) =====
function shake(){
  // --- Params & setup (Runtime contract) ---
  const qs   = new URLSearchParams(location.search);
  const PREV = (qs.get('preview')||'0').trim()==='1';
  const NAME = (qs.get('name')||'Friend').trim();
  const GIFT = (qs.get('giftUrl')||'#').trim();

  // Copy with URL overrides (all English by default per brief)
  const copy = {
    introTitle: (qs.get('introTitle') || `${NAME}, your friend left you a gift!`).slice(0,80),
    introSub:   (qs.get('introSub')   || `To claim it, please verify your identity. Tap below for a quick check.`).slice(0,120),
    introBtn:   (qs.get('introBtn')   || `Verify identity to get the gift`).slice(0,48),

    countTitle: (qs.get('countTitle') || `When the countdown ends, shake your phone`).slice(0,80),
    shakeHint:  (qs.get('shakeHint')  || `Shake now!`).slice(0,40),

    err1Title:  (qs.get('err1Title')  || `Error`).slice(0,40),
    err1Text:   (qs.get('err1Text')   || `We couldn’t verify it. Try again.`).slice(0,120),

    err2Title:  (qs.get('err2Title')  || `Hmm… still not it`).slice(0,40),
    err2Text:   (qs.get('err2Text')   || `Try shaking to the other side.`).slice(0,120),

    err3Title:  (qs.get('err3Title')  || `Shake harder! Didn’t eat breakfast? 😈`).slice(0,80),
    err3Text:   (qs.get('err3Text')   || `Give it your best shot.`).slice(0,120),

    okTitle:    (qs.get('okTitle')    || `You earned it 🤣`).slice(0,80),
    okSub:      (qs.get('okSub')      || `Ready for the real gift?`).slice(0,120),
    okBtn:      (qs.get('okBtn')      || `To the real gift`).slice(0,40),
    love:       (qs.get('love')       || `Love you 😘`).slice(0,40)
  };

  // --- CSS injection (scoped & centered, Assistant font) ---
  (function injectCSS(){
    if (document.getElementById('shake-ux')) return;
    const css = `
      /* Prefer Assistant; fallback to system. The font itself loads in Main. */
      body, .phone, .wrap, #app { font-family: 'Assistant', system-ui, Segoe UI, Roboto, Helvetica, Arial; }

      .wrap-shake{
        display:grid; gap:24px; justify-items:center; text-align:center;
        margin-top:clamp(24px, 10vh, 96px);
      }
      .sh-title{ margin:0; font-size:26px; line-height:1.25; font-weight:800 }
      .sh-sub{ margin:0; font-size:15px; color:#9aa3b2 }
      .sh-cta{ width:min(320px,100%); min-height:48px; padding:14px 18px; font-size:16px; border-radius:16px; font-weight:800 }
      .green{ background:#10b981; color:#fff } .ghost{ background:#0b1020; color:#9aa3b2; border:1px solid rgba(255,255,255,.12) }

      .sh-count{ font-size:92px; font-weight:900; line-height:1; letter-spacing:.5px; margin:6px 0 2px }
      .sh-zone{ display:grid; gap:12px; justify-items:center; }
      .sh-phone{
        width:min(220px,70vw); aspect-ratio:9/16; border-radius:22px;
        border:1px solid rgba(255,255,255,.10); background:#12182b;
        box-shadow:inset 0 0 0 1px rgba(255,255,255,.06), 0 20px 40px rgba(0,0,0,.35);
         /* חדש: תצוגה כעמודה פנימית כדי שהטקסט יהיה מעל האימוג'י */
  display:grid; align-content:center; justify-items:center; gap:8px; padding:14px;
  user-select:none; position:relative;
      }
      /* האימוג'י שבפנים */
.sh-emoji{ font-size:54px; line-height:1; }
/* "ממלא" את המסגרת בניסיון האחרון */
.sh-emoji.fill{ font-size:120px; }
/* הכיתוב בתוך המסגרת מעל האימוג'י – בולט ולא מפוספס */
.sh-hint-in{
  font-size:14px; font-weight:900; color:#e8ecf4; letter-spacing:.2px;
  background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.12);
  padding:6px 10px; border-radius:999px; box-shadow:0 6px 18px rgba(0,0,0,.25);
  animation: shPulse 1.2s ease-in-out infinite alternate;
}
@keyframes shPulse{ from{ transform:translateY(0) scale(1) } to{ transform:translateY(-2px) scale(1.02) } }
      .sh-hint{ font-size:14px; color:#cbd5e1; font-weight:700 }
      .sh-meter{ height:10px; width:min(320px,100%); border-radius:999px; overflow:hidden; background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.08) }
      .sh-meter > i{ display:block; height:100%; width:0%; background:linear-gradient(90deg,#60a5fa,#a78bfa); transition:width .06s linear }

      /* Toast (error) with blurred backdrop */
      .sh-toast{ position:fixed; inset:0; display:none; place-items:center;
        background:rgba(10,12,22,.55); backdrop-filter:blur(6px); z-index:1000; padding:24px; text-align:center }
      .sh-toast.show{ display:grid }
      .sh-toast .box{ background:#1a1f35; border-radius:16px; padding:20px; box-shadow:0 10px 30px rgba(0,0,0,.4); max-width:320px }
      .sh-toast h3{ margin:0 0 6px 0 }

      /* Emojis animate on "shake now" */
      @keyframes wobble { 0%,100%{transform:translateX(0) rotate(0)} 15%{transform:translateX(-6px) rotate(-2deg)} 30%{transform:translateX(6px) rotate(2deg)} 45%{transform:translateX(-4px) rotate(-1deg)} 60%{transform:translateX(4px) rotate(1deg)} 75%{transform:translateX(-2px) rotate(-1deg)} }
      .wobble{ animation:wobble .9s ease-in-out infinite }

      /* reuse gentle shake keyframes from skeleton (.shake class) */
      .shake{ animation:infShake .35s linear 1 }

      /* Confetti canvas (identical pattern to other features) */
      .confetti-canvas{ position:fixed; inset:0; pointer-events:none; z-index:999; display:none }
    `;
    const st = document.createElement('style'); st.id='shake-ux'; st.textContent=css;
    (document.head || document.documentElement).appendChild(st);
  })();

  const app = document.getElementById('app');
  app.classList.remove('card'); // "מסך נקי" כמו שאר הפיצ'רים.  :contentReference[oaicite:8]{index=8}

  // --- Confetti (same engine used in runtime skeleton) ---
  function confettiBurst(canvas){
    if(!canvas) return;
    const ctx = canvas.getContext('2d');
    const r = window.devicePixelRatio || 1;
    function size(){ canvas.width = canvas.clientWidth * r; canvas.height = canvas.clientHeight * r; ctx.setTransform(r,0,0,r,0,0); }
    if(!canvas.__sized){ canvas.__sized = true; canvas.style.display='block'; size(); addEventListener('resize', size); }
    const colors = ['#a78bfa','#60a5fa','#34d399','#f472b6','#f59e0b'];
    const pieces = [];
    const w = canvas.clientWidth, h = canvas.clientHeight;
    for(let i=0;i<120;i++){
      pieces.push({ x:w/2, y:h/2, vx:(Math.random()*4-2), vy:(Math.random()*-3-2),
        r:Math.random()*6+3, c:colors[(Math.random()*colors.length)|0], a:1, spin:(Math.random()*6.28), vr:(Math.random()*0.2-0.1) });
    }
    const g = 0.05; let t=0;
    (function step(){
      ctx.clearRect(0,0,w,h);
      pieces.forEach(p=>{
        p.vy += g; p.x += p.vx; p.y += p.vy; p.spin += p.vr; p.a -= 0.008;
        ctx.globalAlpha = Math.max(p.a,0);
        ctx.save(); ctx.translate(p.x,p.y); ctx.rotate(p.spin);
        ctx.fillStyle = p.c; ctx.fillRect(-p.r/2,-p.r/2,p.r,p.r);
        ctx.restore();
      });
      ctx.globalAlpha = 1;
      if(t++<260) requestAnimationFrame(step); else ctx.clearRect(0,0,w,h);
    })();
  }

  // --- Shake sensor (optional; we still force first 3 attempts to "fail" for the prank) ---
  let motionOn = false, last = {x:0,y:0,z:0}, handler = null;
  function startMotion(onLevel){
    // iOS permission
    try{
      if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function'){
        DeviceMotionEvent.requestPermission().then(st=>{
          if(st==='granted') attach(); // else: silent fallback
        }).catch(()=>{ /* ignore */ });
      } else {
        attach();
      }
    }catch(_){ /* no sensor - ignore */ }

    function attach(){
      if (handler) return;
      handler = (e)=>{
        const acc = e.accelerationIncludingGravity || e.acceleration || {x:0,y:0,z:0};
        // very light high-pass: diff between frames
        const dx = (acc.x||0) - last.x, dy=(acc.y||0)-last.y, dz=(acc.z||0)-last.z;
        last = {x:acc.x||0, y:acc.y||0, z:acc.z||0};
        let mag = Math.sqrt(dx*dx + dy*dy + dz*dz) * 5; // scale up for UI
        mag = Math.max(0, Math.min(100, Math.floor(mag)));
        onLevel && onLevel(mag);
      };
      addEventListener('devicemotion', handler, { passive:true });
      motionOn = true;
    }
  }
  function stopMotion(){
    try{ removeEventListener('devicemotion', handler, { passive:true }); }catch(_){}
    handler = null; motionOn = false;
  }

  // --- Flow screens ---
  let attempt = 0; // 1..3 = forced error; 4 = success

  function screenIntro(){
    app.innerHTML = `
      <div class="wrap wrap-shake">
        <h1 class="sh-title">${copy.introTitle}</h1>
        <p class="sh-sub">${copy.introSub}</p>
        <button id="shStart" class="btn sh-cta green">${copy.introBtn}</button>
        <div class="sh-sub" style="font-size:12px">no data collected</div>
      </div>
    `;
    document.getElementById('shStart')?.addEventListener('click', ()=>{ runAttempt(); }, { once:true });
  }

  function runAttempt(){
    attempt += 1;
    stopMotion(); // reset any previous
    app.innerHTML = `
      <div class="wrap wrap-shake">
        <h1 class="sh-title">${copy.countTitle}</h1>
        <div id="shCount" class="sh-count">5</div>
        <div class="sh-zone" id="shZone" style="display:none">
  <div class="sh-phone wobble" aria-hidden="true">
    <div id="shHintIn" class="sh-hint-in">${copy.shakeHint}</div>
    <div id="shEmoji" class="sh-emoji ${attempt>=4 ? 'fill' : ''}">${attempt>=4 ? '🤣' : '📱'}</div>
  </div>
  <div class="sh-meter"><i id="shBar"></i></div>
</div>
        ${ PREV ? `<div class="sh-sub">Preview mode</div>` : `` }
        <canvas id="shConfetti" class="confetti-canvas"></canvas>
      </div>
      <!-- three toasts (errors) -->
      <div id="shErr1" class="sh-toast"><div class="box"><h3>${copy.err1Title}</h3><p>${copy.err1Text}</p><div style="height:10px"></div><button class="btn sh-cta green" data-ok>Try again</button></div></div>
      <div id="shErr2" class="sh-toast"><div class="box"><h3>${copy.err2Title}</h3><p>${copy.err2Text}</p><div style="height:10px"></div><button class="btn sh-cta green" data-ok>Try again</button></div></div>
      <div id="shErr3" class="sh-toast"><div class="box"><h3>${copy.err3Title}</h3><p>${copy.err3Text}</p><div style="height:10px"></div><button class="btn sh-cta green" data-ok>Try again, hero!</button></div></div>
    `;

    // countdown 5→1
    const cnt = document.getElementById('shCount');
    const zone = document.getElementById('shZone');
    const bar  = document.getElementById('shBar');

    let n = 5;
    cnt.textContent = String(n);
    const t = setInterval(()=>{
      n -= 1;
      if(n<=0){
        clearInterval(t);
        cnt.style.display='none';
        zone.style.display='grid';
        // start sensor (visual only)
        startMotion(level => { if(bar) bar.style.width = level + '%'; });
        // after 5s → either error (1..3) or success (4+)
        setTimeout(()=>{
          stopMotion();
          if (attempt <= 3){
            // subtle error shake
            document.querySelector('.wrap-shake')?.classList.add('shake');
            setTimeout(()=>document.querySelector('.wrap-shake')?.classList.remove('shake'), 380);
            (document.getElementById('shErr'+attempt)).classList.add('show');
            // ok handlers
            document.querySelectorAll('#shErr'+attempt+' [data-ok]').forEach(btn=>{
              btn.addEventListener('click', ()=>{
                (document.getElementById('shErr'+attempt)).classList.remove('show');
                runAttempt();
              }, { once:true });
            });
          } else {
            screenSuccess();
          }
        }, 5000);
      } else {
        cnt.textContent = String(n);
      }
    }, 1000);
  }

  function screenSuccess(){
    app.innerHTML = `
      <div class="wrap wrap-shake">
        <h1 class="sh-title">${copy.okTitle}</h1>
        <p class="sh-sub">${copy.okSub}</p>
        <button id="shOpen" class="btn sh-cta green"${PREV?' disabled':''}>${copy.okBtn}</button>
        <div class="sh-sub" style="font-size:12px">${copy.love}</div>
        ${ PREV ? `<div class="sh-sub">Preview only — button disabled</div>` : `` }
        <canvas id="shConfetti2" class="confetti-canvas"></canvas>
      </div>
    `;
    confettiBurst(document.getElementById('shConfetti2'));
    document.getElementById('shOpen')?.addEventListener('click', ()=>{
      if(PREV) return;
      try{ window.open(GIFT, '_blank', 'noopener'); }catch(_){}
    });
  }

  // GO
  screenIntro();
}
  
const map = {
'voice-verify': voiceVerify,
'captcha': captcha,
'infinite': infinite,
'narcissist-q': narcissistQ,
'selfie-verify': selfieVerify,
'shake': shake
};

(map[F] || (()=>el('<h1 class="h1">Feature not found</h1><p class="p">Use ?f=voice-verify|captcha|infinite|narcissist-q|selfie-verify|shake</p>')))();
})();
</script>
